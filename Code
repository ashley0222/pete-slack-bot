import 'dotenv/config';
import { App, ExpressReceiver, LogLevel } from '@slack/bolt';
import OpenAI from 'openai';

const {
  SLACK_BOT_TOKEN,
  SLACK_SIGNING_SECRET,
  OPENAI_API_KEY,
  DRIVE_LIBRARY_URL,
  PORT = process.env.PORT || 10000
} = process.env;

// HTTP receiver exposes /slack/events for Slack verification
const receiver = new ExpressReceiver({
  signingSecret: SLACK_SIGNING_SECRET,
  processBeforeResponse: true
});

// Health check so you can open your Render URL and see it's running
receiver.router.get('/', (_req, res) => {
  res.status(200).send('PETE Slack bot is up (HTTP mode).');
});

const app = new App({
  token: SLACK_BOT_TOKEN,
  signingSecret: SLACK_SIGNING_SECRET,
  receiver,
  logLevel: LogLevel.INFO
});

const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

const PETE_SYSTEM_PROMPT = `
You are PETE, a friendly, knowledgeable AI assistant for Pest Pros employees.
Mission: provide practical, safety-first guidance in pest ID, product selection, treatment prep, efficient workflows, and internal ops (Slack check-ins/outs, reporting).
Tone: casual, team-oriented coach; supportive and clear.

Safety:
- Always prioritize the product label, proper PPE, exclusion steps, and accurate documentation.
- No off-label recommendations, no unapproved or brand-new products, no guarantees without inspection, no legal interpretation.
- If lacking details, ask concise, targeted questions; otherwise deliver complete, actionable steps.

Internal references (cite when relevant):
- Commission Procedure for Sales and Payment
- Flea Preparation Form
- German Roaches Treatment Preparation Form
- Pest Pro Services Rain Protocol
- Yard Treatment Requirements
- Missing Receipt Form
- PETE Slack + Google Sheets reporting process
- General Pest Control Service Agreement
- Commercial & Residential Proposal Templates
- Termite Treatment Prep & Safety Checklist
- Wildlife Exclusion Procedure
- Ant & Pantry Pest Prep Sheet
- P.R.O.S. Team Standards
- Rodent vs Roach Droppings ID Guide
- Central library: ${DRIVE_LIBRARY_URL}

Slack workflow PETE reinforces:
- Morning check-in (by 8:30 AM) with 3-line format (stops, breakdown, revenue).
- End-of-day check-out (by 6:00 PM) with final counts and revenue.
- Leadership daily/weekly/monthly summaries (professional tone).
`;

async function askPETE(userText, userName) {
  const messages = [
    { role: 'system', content: PETE_SYSTEM_PROMPT },
    { role: 'user', content: `${userName ? `From @${userName}: ` : ''}${userText}` }
  ];
  const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    temperature: 0.3,
    messages
  });
  return completion.choices?.[0]?.message?.content?.trim() || 'Sorry — I had trouble formulating a response.';
}

// Slash command: /pete
app.command('/pete', async ({ command, ack, respond }) => {
  await ack();
  const text = (command.text || '').trim() || 'help';

  if (text === 'help') {
    return respond({
      response_type: 'ephemeral',
      text:
        'PETE commands:\n' +
        '• `/pete checkin format` – morning check-in template\n' +
        '• `/pete checkout format` – end-of-day template\n' +
        '• Ask anything: `/pete german roach prep`'
    });
  }

  if (text === 'checkin format') {
    return respond({
      response_type: 'ephemeral',
      text:
        'Check-in (by 8:30 AM):\n' +
        '```\n20 stops today\n13 exteriors, 3 P+, 2 follow-ups, 2 renewals\n$1475\n```'
    });
  }

  if (text === 'checkout format') {
    return respond({
      response_type: 'ephemeral',
      text:
        'Check-out (by 6:00 PM):\n' +
        '```\n14 stops today\n5 exteriors, 1 initial, 1 estimate, 3 P+, 1 go-by, 3 mosquitoes\n$985\n```'
    });
  }

  try {
    const answer = await askPETE(text, command.user_name);
    return respond({ response_type: 'in_channel', text: answer });
  } catch (err) {
    return respond({ response_type: 'ephemeral', text: `Error: ${err.message || err}` });
  }
});

// @mentions in channels
app.event('app_mention', async ({ event, client, say }) => {
  const text = (event.text || '').replace(/<@[^>]+>\s*/, '');
  await say({ text: `_On it…_`, thread_ts: event.ts });

  const userInfo = await client.users.info({ user: event.user });
  const username = userInfo?.user?.name || 'user';

  try {
    const answer = await askPETE(text, username);
    await client.chat.postMessage({ channel: event.channel, text: answer, thread_ts: event.ts });
  } catch (err) {
    await client.chat.postMessage({ channel: event.channel, text: `I hit an error: ${err.message || err}`, thread_ts: event.ts });
  }
});

// DMs
app.event('message', async ({ event, client }) => {
  if (event.channel_type !== 'im' || event.subtype) return;
  const userInfo = await client.users.info({ user: event.user });
  const username = userInfo?.user?.name || 'user';

  try {
    const answer = await askPETE(event.text || '', username);
    await client.chat.postMessage({ channel: event.channel, text: answer });
  } catch (err) {
    await client.chat.postMessage({ channel: event.channel, text: `Error: ${err.message || err}` });
  }
});

(async () => {
  await app.start(PORT);
  console.log(`PETE listening on port ${PORT} (HTTP mode).`);
})();
{
  "name": "pete-slack-bot",
  "version": "1.0.0",
  "type": "module",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "@slack/bolt": "^3.18.0",
    "dotenv": "^16.4.5",
    "openai": "^4.61.1"
  }
}
SLACK_BOT_TOKEN=
SLACK_SIGNING_SECRET=
OPENAI_API_KEY=
DRIVE_LIBRARY_URL=https://drive.google.com/drive/folders/17ffwyzquvLyEX_PhLCu7vc9HeoczB6Yo
PORT=10000
# PETE Slack Bot (Render + Slack HTTP Mode)

## Env Vars
- SLACK_BOT_TOKEN (xoxb-…)
- SLACK_SIGNING_SECRET
- OPENAI_API_KEY
- DRIVE_LIBRARY_URL
- PORT (Render sets, default 10000)

## Start locally
npm install
SLACK_BOT_TOKEN=... SLACK_SIGNING_SECRET=... OPENAI_API_KEY=... node index.js

## Deploy on Render
Build: npm install
Start: node index.js
